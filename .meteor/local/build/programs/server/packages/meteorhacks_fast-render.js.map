{"version":3,"sources":["meteor://ðŸ’»app/packages/meteorhacks_fast-render/packages/meteorhacks_fast-render.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6H","file":"/packages/meteorhacks_fast-render.js","sourcesContent":["(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/utils.js                                                                  //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nAddedToChanged = function(localCopy, added) {                                                                     // 1\n  added.msg = \"changed\";                                                                                          // 2\n  added.cleared = [];                                                                                             // 3\n  added.fields = added.fields || {};                                                                              // 4\n                                                                                                                  // 5\n  _.each(localCopy, function(value, key) {                                                                        // 6\n    if(key != '_id') {                                                                                            // 7\n      if(typeof added.fields[key] == \"undefined\") {                                                               // 8\n        added.cleared.push(key);                                                                                  // 9\n      }                                                                                                           // 10\n    }                                                                                                             // 11\n  });                                                                                                             // 12\n};                                                                                                                // 13\n                                                                                                                  // 14\nApplyDDP = function(existing, message) {                                                                          // 15\n  var newDoc = (!existing)? {}: _.clone(existing);                                                                // 16\n  if(message.msg == 'added') {                                                                                    // 17\n    _.each(message.fields, function(value, key) {                                                                 // 18\n      newDoc[key] = value;                                                                                        // 19\n    });                                                                                                           // 20\n  } else if(message.msg == \"changed\") {                                                                           // 21\n    _.each(message.fields, function(value, key) {                                                                 // 22\n      newDoc[key] = value;                                                                                        // 23\n    });                                                                                                           // 24\n    _.each(message.cleared, function(key) {                                                                       // 25\n      delete newDoc[key];                                                                                         // 26\n    });                                                                                                           // 27\n  } else if(message.msg == \"removed\") {                                                                           // 28\n    newDoc = null;                                                                                                // 29\n  }                                                                                                               // 30\n                                                                                                                  // 31\n  return newDoc;                                                                                                  // 32\n};                                                                                                                // 33\n                                                                                                                  // 34\n// source: https://gist.github.com/kurtmilam/1868955                                                              // 35\n//  modified a bit to not to expose this as an _ api                                                              // 36\nDeepExtend = function deepExtend (obj) {                                                                          // 37\n  var parentRE = /#{\\s*?_\\s*?}/,                                                                                  // 38\n      slice = Array.prototype.slice,                                                                              // 39\n      hasOwnProperty = Object.prototype.hasOwnProperty;                                                           // 40\n                                                                                                                  // 41\n  _.each(slice.call(arguments, 1), function(source) {                                                             // 42\n    for (var prop in source) {                                                                                    // 43\n      if (hasOwnProperty.call(source, prop)) {                                                                    // 44\n        if (_.isNull(obj[prop]) || _.isUndefined(obj[prop]) || _.isFunction(obj[prop]) || _.isNull(source[prop]) || _.isDate(source[prop])) {\n          obj[prop] = source[prop];                                                                               // 46\n        }                                                                                                         // 47\n        else if (_.isString(source[prop]) && parentRE.test(source[prop])) {                                       // 48\n          if (_.isString(obj[prop])) {                                                                            // 49\n            obj[prop] = source[prop].replace(parentRE, obj[prop]);                                                // 50\n          }                                                                                                       // 51\n        }                                                                                                         // 52\n        else if (_.isArray(obj[prop]) || _.isArray(source[prop])){                                                // 53\n          if (!_.isArray(obj[prop]) || !_.isArray(source[prop])){                                                 // 54\n            throw 'Error: Trying to combine an array with a non-array (' + prop + ')';                            // 55\n          } else {                                                                                                // 56\n            obj[prop] = _.reject(DeepExtend(obj[prop], source[prop]), function (item) { return _.isNull(item);}); // 57\n          }                                                                                                       // 58\n        }                                                                                                         // 59\n        else if (_.isObject(obj[prop]) || _.isObject(source[prop])){                                              // 60\n          if (!_.isObject(obj[prop]) || !_.isObject(source[prop])){                                               // 61\n            throw 'Error: Trying to combine an object with a non-object (' + prop + ')';                          // 62\n          } else {                                                                                                // 63\n            obj[prop] = DeepExtend(obj[prop], source[prop]);                                                      // 64\n          }                                                                                                       // 65\n        } else {                                                                                                  // 66\n          obj[prop] = source[prop];                                                                               // 67\n        }                                                                                                         // 68\n      }                                                                                                           // 69\n    }                                                                                                             // 70\n  });                                                                                                             // 71\n  return obj;                                                                                                     // 72\n};                                                                                                                // 73\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/server/namespace.js                                                       //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nFastRender = {                                                                                                    // 1\n  _routes: [],                                                                                                    // 2\n  _onAllRoutes: []                                                                                                // 3\n};                                                                                                                // 4\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/server/utils.js                                                           //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\n// meteor algorithm to check if this is a meteor serving http request or not                                      // 1\nIsAppUrl = function (req) {                                                                                       // 2\n  var url = req.url                                                                                               // 3\n  if(url === '/favicon.ico' || url === '/robots.txt') {                                                           // 4\n    return false;                                                                                                 // 5\n  }                                                                                                               // 6\n                                                                                                                  // 7\n  // NOTE: app.manifest is not a web standard like favicon.ico and                                                // 8\n  // robots.txt. It is a file name we have chosen to use for HTML5                                                // 9\n  // appcache URLs. It is included here to prevent using an appcache                                              // 10\n  // then removing it from poisoning an app permanently. Eventually,                                              // 11\n  // once we have server side routing, this won't be needed as                                                    // 12\n  // unknown URLs with return a 404 automatically.                                                                // 13\n  if(url === '/app.manifest') {                                                                                   // 14\n    return false;                                                                                                 // 15\n  }                                                                                                               // 16\n                                                                                                                  // 17\n  // Avoid serving app HTML for declared routes such as /sockjs/.                                                 // 18\n  if(RoutePolicy.classify(url)) {                                                                                 // 19\n    return false;                                                                                                 // 20\n  }                                                                                                               // 21\n                                                                                                                  // 22\n  // we only need to support HTML pages only                                                                      // 23\n  // this is a check to do it                                                                                     // 24\n  return /html/.test(req.headers['accept']);                                                                      // 25\n};                                                                                                                // 26\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/server/routes.js                                                          //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nvar Fiber = Npm.require('fibers');                                                                                // 1\nFastRender._onAllRoutes = [];                                                                                     // 2\nFastRender.frContext = new Meteor.EnvironmentVariable();                                                          // 3\n                                                                                                                  // 4\nvar fastRenderRoutes = Picker.filter(function(req, res) {                                                         // 5\n  return IsAppUrl(req);                                                                                           // 6\n});                                                                                                               // 7\nfastRenderRoutes.middleware(Npm.require('connect').cookieParser());                                               // 8\nfastRenderRoutes.middleware(function(req, res, next) {                                                            // 9\n  FastRender.handleOnAllRoutes(req, res, next);                                                                   // 10\n});                                                                                                               // 11\n                                                                                                                  // 12\n// handling specific routes                                                                                       // 13\nFastRender.route = function route(path, callback) {                                                               // 14\n  if(path.indexOf('/') !== 0){                                                                                    // 15\n    throw new Error('Error: path (' + path + ') must begin with a leading slash \"/\"')                             // 16\n  }                                                                                                               // 17\n  fastRenderRoutes.route(path, FastRender.handleRoute.bind(null, callback));                                      // 18\n};                                                                                                                // 19\n                                                                                                                  // 20\nfunction setQueryDataCallback(res, next) {                                                                        // 21\n  return function(queryData) {                                                                                    // 22\n    if(!queryData) return next();                                                                                 // 23\n                                                                                                                  // 24\n    var existingPayload = res.getData(\"fast-render-data\");                                                        // 25\n    if(!existingPayload) {                                                                                        // 26\n      res.pushData(\"fast-render-data\", queryData);                                                                // 27\n    } else {                                                                                                      // 28\n      // it's possible to execute this callback twice                                                             // 29\n      // the we need to merge exisitng data with the new one                                                      // 30\n      _.extend(existingPayload.subscriptions, queryData.subscriptions);                                           // 31\n      _.each(queryData.collectionData, function(data, pubName) {                                                  // 32\n        var existingData = existingPayload.collectionData[pubName]                                                // 33\n        if(existingData) {                                                                                        // 34\n          data = existingData.concat(data);                                                                       // 35\n        }                                                                                                         // 36\n                                                                                                                  // 37\n        existingPayload.collectionData[pubName] = data;                                                           // 38\n        res.pushData('fast-render-data', existingPayload);                                                        // 39\n      });                                                                                                         // 40\n    }                                                                                                             // 41\n    next();                                                                                                       // 42\n  };                                                                                                              // 43\n}                                                                                                                 // 44\n                                                                                                                  // 45\nFastRender.handleRoute = function(processingCallback, params, req, res, next) {                                   // 46\n  var afterProcessed = setQueryDataCallback(res, next);                                                           // 47\n  FastRender._processRoutes(params, req, processingCallback, afterProcessed);                                     // 48\n};                                                                                                                // 49\n                                                                                                                  // 50\nFastRender.handleOnAllRoutes = function(req, res, next) {                                                         // 51\n  var afterProcessed = setQueryDataCallback(res, next);                                                           // 52\n  FastRender._processAllRoutes(req, afterProcessed);                                                              // 53\n};                                                                                                                // 54\n                                                                                                                  // 55\nFastRender.onAllRoutes = function onAllRoutes(callback) {                                                         // 56\n  FastRender._onAllRoutes.push(callback);                                                                         // 57\n};                                                                                                                // 58\n                                                                                                                  // 59\nFastRender._processRoutes =                                                                                       // 60\n  function _processRoutes(params, req, routeCallback, callback) {                                                 // 61\n  callback = callback || function() {};                                                                           // 62\n                                                                                                                  // 63\n  var path = req.url;                                                                                             // 64\n  var loginToken = req.cookies['meteor_login_token'];                                                             // 65\n  var headers = req.headers;                                                                                      // 66\n                                                                                                                  // 67\n  var context = new Context(loginToken, { headers: headers });                                                    // 68\n                                                                                                                  // 69\n  try {                                                                                                           // 70\n    FastRender.frContext.withValue(context, function() {                                                          // 71\n      routeCallback.call(context, params, path);                                                                  // 72\n    });                                                                                                           // 73\n    callback(context.getData());                                                                                  // 74\n  } catch(err) {                                                                                                  // 75\n    handleError(err, path, callback);                                                                             // 76\n  }                                                                                                               // 77\n};                                                                                                                // 78\n                                                                                                                  // 79\nFastRender._processAllRoutes =                                                                                    // 80\n  function _processAllRoutes(req, callback) {                                                                     // 81\n  callback = callback || function() {};                                                                           // 82\n                                                                                                                  // 83\n  var path = req.url;                                                                                             // 84\n  var loginToken = req.cookies['meteor_login_token'];                                                             // 85\n  var headers = req.headers;                                                                                      // 86\n                                                                                                                  // 87\n  new Fiber(function() {                                                                                          // 88\n    var context = new Context(loginToken, { headers: headers });                                                  // 89\n                                                                                                                  // 90\n    try {                                                                                                         // 91\n      FastRender._onAllRoutes.forEach(function(callback) {                                                        // 92\n        callback.call(context, req.url);                                                                          // 93\n      });                                                                                                         // 94\n                                                                                                                  // 95\n      callback(context.getData());                                                                                // 96\n    } catch(err) {                                                                                                // 97\n      handleError(err, path, callback);                                                                           // 98\n    }                                                                                                             // 99\n  }).run();                                                                                                       // 100\n};                                                                                                                // 101\n                                                                                                                  // 102\nfunction handleError(err, path, callback) {                                                                       // 103\n  var message =                                                                                                   // 104\n    'error on fast-rendering path: ' +                                                                            // 105\n    path +                                                                                                        // 106\n    \" ; error: \" + err.stack;                                                                                     // 107\n  console.error(message);                                                                                         // 108\n  callback(null);                                                                                                 // 109\n}                                                                                                                 // 110\n                                                                                                                  // 111\n// adding support for null publications                                                                           // 112\nFastRender.onAllRoutes(function() {                                                                               // 113\n  var context = this;                                                                                             // 114\n  var nullHandlers = Meteor.default_server.universal_publish_handlers;                                            // 115\n                                                                                                                  // 116\n  if(nullHandlers) {                                                                                              // 117\n    nullHandlers.forEach(function(publishHandler) {                                                               // 118\n      // console.log(publishHandler.toString());                                                                  // 119\n      var publishContext = new PublishContext(context, null);                                                     // 120\n      var params = [];                                                                                            // 121\n      context.processPublication(publishHandler, publishContext, params);                                         // 122\n                                                                                                                  // 123\n    });                                                                                                           // 124\n  }                                                                                                               // 125\n});                                                                                                               // 126\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/server/publish_context.js                                                 //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nPublishContext = function PublishContext(context, subscription) {                                                 // 1\n  this.userId = context.userId;                                                                                   // 2\n  this.unblock = function() {};                                                                                   // 3\n  this._subscription = subscription;                                                                              // 4\n  this._context = context;                                                                                        // 5\n  this._collectionData = {};                                                                                      // 6\n  this._onStop = [];                                                                                              // 7\n  this._stopped = false;                                                                                          // 8\n                                                                                                                  // 9\n  // connection object                                                                                            // 10\n  this.connection = {                                                                                             // 11\n    _id: Meteor.uuid(),                                                                                           // 12\n    close: function() {},                                                                                         // 13\n    onClose: function() {},                                                                                       // 14\n    // fake value, will be supported later on                                                                     // 15\n    clientAddress: \"127.0.0.1\",                                                                                   // 16\n    httpHeaders: context.headers                                                                                  // 17\n  };                                                                                                              // 18\n                                                                                                                  // 19\n  // we won't be supporting all the other fields of the Meteor's                                                  // 20\n  // Subscription class since they are private variables                                                          // 21\n};                                                                                                                // 22\n                                                                                                                  // 23\nPublishContext.prototype._ensureCollection = function(collection) {                                               // 24\n  if (!this._collectionData[collection]) {                                                                        // 25\n    this._collectionData[collection] = [];                                                                        // 26\n                                                                                                                  // 27\n    //put this collection data in the parent context                                                              // 28\n    this._context._ensureCollection(collection);                                                                  // 29\n    this._context._collectionData[collection].push(this._collectionData[collection]);                             // 30\n  }                                                                                                               // 31\n};                                                                                                                // 32\n                                                                                                                  // 33\nPublishContext.prototype.added = function(collection, id, fields) {                                               // 34\n  this._ensureCollection(collection);                                                                             // 35\n  var doc = _.clone(fields);                                                                                      // 36\n  doc._id = id;                                                                                                   // 37\n  this._collectionData[collection].push(doc);                                                                     // 38\n};                                                                                                                // 39\n                                                                                                                  // 40\nPublishContext.prototype.changed = function(collection, id, fields) {                                             // 41\n  var collectionData = this._collectionData;                                                                      // 42\n                                                                                                                  // 43\n  collectionData[collection] = collectionData[collection].map(function(doc) {                                     // 44\n    if (doc._id === id) {                                                                                         // 45\n      return _.extend(doc, fields);                                                                               // 46\n    }                                                                                                             // 47\n                                                                                                                  // 48\n    return doc;                                                                                                   // 49\n  });                                                                                                             // 50\n};                                                                                                                // 51\n                                                                                                                  // 52\nPublishContext.prototype.removed = function(collection, id) {                                                     // 53\n  var collectionData = this._collectionData;                                                                      // 54\n                                                                                                                  // 55\n  collectionData[collection] = collectionData[collection].filter(function(doc) {                                  // 56\n    return doc._id !== id;                                                                                        // 57\n  });                                                                                                             // 58\n};                                                                                                                // 59\n                                                                                                                  // 60\nPublishContext.prototype.onStop = function(cb) {                                                                  // 61\n  if (this._stopped) {                                                                                            // 62\n    cb();                                                                                                         // 63\n  } else {                                                                                                        // 64\n    this._onStop.push(cb);                                                                                        // 65\n  }                                                                                                               // 66\n};                                                                                                                // 67\n                                                                                                                  // 68\nPublishContext.prototype.ready = function() {                                                                     // 69\n  this._stopped = true;                                                                                           // 70\n                                                                                                                  // 71\n  //make the subscription be marked as ready                                                                      // 72\n  if(this._subscription) {                                                                                        // 73\n    //don't do this for null subscriptions                                                                        // 74\n    this._context.completeSubscriptions(this._subscription);                                                      // 75\n  }                                                                                                               // 76\n                                                                                                                  // 77\n  //make sure that any observe callbacks are cancelled                                                            // 78\n  this._onStop.forEach(function(cb) {                                                                             // 79\n    cb();                                                                                                         // 80\n  });                                                                                                             // 81\n};                                                                                                                // 82\n                                                                                                                  // 83\nPublishContext.prototype.error = function() {};                                                                   // 84\nPublishContext.prototype.stop = function() {};                                                                    // 85\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/server/context.js                                                         //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nvar Fibers = Npm.require('fibers');                                                                               // 1\nvar Future = Npm.require('fibers/future');                                                                        // 2\n                                                                                                                  // 3\nContext = function Context(loginToken, otherParams) {                                                             // 4\n  this._collectionData = {};                                                                                      // 5\n  this._subscriptions = {};                                                                                       // 6\n  this._loginToken = loginToken;                                                                                  // 7\n                                                                                                                  // 8\n  _.extend(this, otherParams);                                                                                    // 9\n                                                                                                                  // 10\n  // get the user                                                                                                 // 11\n  if(Meteor.users) {                                                                                              // 12\n    // check to make sure, we've the loginToken,                                                                  // 13\n    // otherwise a random user will fetched from the db                                                           // 14\n    if(loginToken) {                                                                                              // 15\n      var hashedToken = loginToken && Accounts._hashLoginToken( loginToken );                                     // 16\n      var query = {'services.resume.loginTokens.hashedToken': hashedToken };                                      // 17\n      var options = {fields: {_id: 1}};                                                                           // 18\n      var user = Meteor.users.findOne(query, options);                                                            // 19\n    }                                                                                                             // 20\n                                                                                                                  // 21\n    //support for Meteor.user                                                                                     // 22\n    Fibers.current._meteor_dynamics = {};                                                                         // 23\n    Fibers.current._meteor_dynamics[DDP._CurrentInvocation.slot] = this;                                          // 24\n                                                                                                                  // 25\n    if(user) {                                                                                                    // 26\n      this.userId = user._id;                                                                                     // 27\n    }                                                                                                             // 28\n  }                                                                                                               // 29\n};                                                                                                                // 30\n                                                                                                                  // 31\nContext.prototype.subscribe = function(subName /*, params */) {                                                   // 32\n  var self = this;                                                                                                // 33\n                                                                                                                  // 34\n  var publishHandler = Meteor.default_server.publish_handlers[subName];                                           // 35\n  if(publishHandler) {                                                                                            // 36\n    var params = Array.prototype.slice.call(arguments, 1);                                                        // 37\n    var subscription = {name: subName, params: params}                                                            // 38\n    var publishContext = new PublishContext(this, subscription);                                                  // 39\n                                                                                                                  // 40\n    return this.processPublication(publishHandler, publishContext, params);                                       // 41\n  } else {                                                                                                        // 42\n    console.warn('There is no such publish handler named:', subName);                                             // 43\n    return {};                                                                                                    // 44\n  }                                                                                                               // 45\n};                                                                                                                // 46\n                                                                                                                  // 47\nContext.prototype.processPublication = function(publishHandler, publishContext, params) {                         // 48\n  var self = this;                                                                                                // 49\n  var data = {};                                                                                                  // 50\n  var ensureCollection = function(collectionName) {                                                               // 51\n    self._ensureCollection(collectionName);                                                                       // 52\n    if(!data[collectionName]) {                                                                                   // 53\n      data[collectionName] = [];                                                                                  // 54\n    }                                                                                                             // 55\n  };                                                                                                              // 56\n                                                                                                                  // 57\n  var future = new Future();                                                                                      // 58\n  //detect when the context is ready to be sent to the client                                                     // 59\n  publishContext.onStop(function() {                                                                              // 60\n    if(!future.isResolved()) {                                                                                    // 61\n      future.return();                                                                                            // 62\n    }                                                                                                             // 63\n  });                                                                                                             // 64\n                                                                                                                  // 65\n  try {                                                                                                           // 66\n    var cursors = publishHandler.apply(publishContext, params);                                                   // 67\n  } catch(ex) {                                                                                                   // 68\n    console.warn('error caught on publication: ', publishContext._subscription, ': ', ex.message);                // 69\n    // since, this subscription caught on an error we can't proceed.                                              // 70\n    // but we can't also throws an error since other publications might have something useful                     // 71\n    // So, it's not fair to ignore running them due to error of this sub                                          // 72\n    // this might also be failed due to the use of some private API's of Meteor's Susbscription class             // 73\n    publishContext.ready();                                                                                       // 74\n  }                                                                                                               // 75\n                                                                                                                  // 76\n  if(cursors) {                                                                                                   // 77\n    //the publish function returned a cursor                                                                      // 78\n    if(cursors.constructor != Array) {                                                                            // 79\n      cursors = [cursors];                                                                                        // 80\n    }                                                                                                             // 81\n                                                                                                                  // 82\n    //add collection data                                                                                         // 83\n    cursors.forEach(function(cursor) {                                                                            // 84\n      cursor.rewind();                                                                                            // 85\n      var collectionName =                                                                                        // 86\n        (cursor._cursorDescription)? cursor._cursorDescription.collectionName: null || //for meteor-collections   // 87\n        (cursor._collection)? cursor._collection._name: null; //for smart-collections                             // 88\n                                                                                                                  // 89\n      ensureCollection(collectionName);                                                                           // 90\n      var cursorData = cursor.fetch();                                                                            // 91\n      data[collectionName].push(cursorData);                                                                      // 92\n      self._collectionData[collectionName].push(cursorData);                                                      // 93\n    });                                                                                                           // 94\n                                                                                                                  // 95\n    //the subscription is ready                                                                                   // 96\n    publishContext.ready();                                                                                       // 97\n  } else if(cursors === null) {                                                                                   // 98\n    //some developers send null to indicate they are not using the publication                                    // 99\n    //this is not the way to go, but meteor's accounts-base also does this                                        // 100\n    //so we need some special handling on this                                                                    // 101\n    publishContext.ready();                                                                                       // 102\n  }                                                                                                               // 103\n                                                                                                                  // 104\n  if (!future.isResolved()) {                                                                                     // 105\n    //don't wait forever for handler to fire ready()                                                              // 106\n    Meteor.setTimeout(function() {                                                                                // 107\n      if (!future.isResolved()) {                                                                                 // 108\n        //publish handler failed to send ready signal in time                                                     // 109\n        console.warn('Publish handler for', publishContext._subscription, 'sent no ready signal');                // 110\n        future.return();                                                                                          // 111\n      }                                                                                                           // 112\n    }, 500);  //arbitrarially set timeout to 500ms, should probably be configurable                               // 113\n                                                                                                                  // 114\n    // wait for the subscription became ready.                                                                    // 115\n    future.wait();                                                                                                // 116\n                                                                                                                  // 117\n    // get the data                                                                                               // 118\n    _.each(publishContext._collectionData, function(collData, collectionName) {                                   // 119\n      ensureCollection(collectionName);                                                                           // 120\n      data[collectionName].push(collData);                                                                        // 121\n    });                                                                                                           // 122\n  }                                                                                                               // 123\n                                                                                                                  // 124\n  return data;                                                                                                    // 125\n};                                                                                                                // 126\n                                                                                                                  // 127\nContext.prototype.completeSubscriptions = function(subscription) {                                                // 128\n  var subs = this._subscriptions[subscription.name];                                                              // 129\n  if(!subs) {                                                                                                     // 130\n    subs = this._subscriptions[subscription.name] = {};                                                           // 131\n  }                                                                                                               // 132\n                                                                                                                  // 133\n  subs[EJSON.stringify(subscription.params)] = true;                                                              // 134\n};                                                                                                                // 135\n                                                                                                                  // 136\nContext.prototype._ensureCollection = function(collectionName) {                                                  // 137\n  if(!this._collectionData[collectionName]) {                                                                     // 138\n    this._collectionData[collectionName] = [];                                                                    // 139\n  }                                                                                                               // 140\n};                                                                                                                // 141\n                                                                                                                  // 142\nContext.prototype.getData = function() {                                                                          // 143\n  return {                                                                                                        // 144\n    collectionData: this._collectionData,                                                                         // 145\n    subscriptions: this._subscriptions,                                                                           // 146\n    loginToken: this._loginToken                                                                                  // 147\n  };                                                                                                              // 148\n};                                                                                                                // 149\n                                                                                                                  // 150\nFastRender._Context = Context;                                                                                    // 151\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                //\n// packages/meteorhacks:fast-render/lib/server/iron_router_support.js                                             //\n//                                                                                                                //\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                  //\nif(!Package['iron:router']) return;                                                                               // 1\n                                                                                                                  // 2\nvar RouteController = Package['iron:router'].RouteController;                                                     // 3\nvar Router = Package['iron:router'].Router;                                                                       // 4\n                                                                                                                  // 5\nvar currentSubscriptions = [];                                                                                    // 6\nMeteor.subscribe = function(subscription) {                                                                       // 7\n  currentSubscriptions.push(arguments);                                                                           // 8\n};                                                                                                                // 9\n                                                                                                                  // 10\n//assuming, no runtime routes will be added                                                                       // 11\nMeteor.startup(function() {                                                                                       // 12\n  // this is trick to run the processRoutes at the                                                                // 13\n  // end of all Meteor.startup callbacks                                                                          // 14\n  Meteor.startup(processRoutes);                                                                                  // 15\n});                                                                                                               // 16\n                                                                                                                  // 17\nfunction processRoutes() {                                                                                        // 18\n  Router.routes.forEach(function(route) {                                                                         // 19\n    route.options = route.options || {};                                                                          // 20\n    if(route.options.fastRender) {                                                                                // 21\n      handleRoute(route);                                                                                         // 22\n    } else if(                                                                                                    // 23\n        getController(route) &&                                                                                   // 24\n        getController(route).prototype &&                                                                         // 25\n        getController(route).prototype.fastRender                                                                 // 26\n    ) {                                                                                                           // 27\n      handleRoute(route);                                                                                         // 28\n    }                                                                                                             // 29\n  });                                                                                                             // 30\n                                                                                                                  // 31\n  // getting global waitOns                                                                                       // 32\n  var globalWaitOns = [];                                                                                         // 33\n  if(Router._globalHooks && Router._globalHooks.waitOn && Router._globalHooks.waitOn.length > 0) {                // 34\n    Router._globalHooks.waitOn.forEach(function(waitOn) {                                                         // 35\n      globalWaitOns.push(waitOn.hook);                                                                            // 36\n    });                                                                                                           // 37\n  }                                                                                                               // 38\n                                                                                                                  // 39\n  FastRender.onAllRoutes(function(path) {                                                                         // 40\n    var self = this;                                                                                              // 41\n                                                                                                                  // 42\n    currentSubscriptions = [];                                                                                    // 43\n    globalWaitOns.forEach(function(waitOn) {                                                                      // 44\n      waitOn.call({path: path});                                                                                  // 45\n    });                                                                                                           // 46\n                                                                                                                  // 47\n    currentSubscriptions.forEach(function(args) {                                                                 // 48\n      self.subscribe.apply(self, args);                                                                           // 49\n    });                                                                                                           // 50\n  });                                                                                                             // 51\n};                                                                                                                // 52\n                                                                                                                  // 53\nfunction handleRoute(route) {                                                                                     // 54\n  var subscriptionFunctions = [];                                                                                 // 55\n                                                                                                                  // 56\n  // get potential subscription handlers from the route options                                                   // 57\n  ['waitOn', 'subscriptions'].forEach(function(funcName) {                                                        // 58\n    var handler = route.options[funcName];                                                                        // 59\n    if(typeof handler == 'function') {                                                                            // 60\n      subscriptionFunctions.push(handler);                                                                        // 61\n    } else if (handler instanceof Array) {                                                                        // 62\n      handler.forEach(function(func) {                                                                            // 63\n        if(typeof func == 'function') {                                                                           // 64\n          subscriptionFunctions.push(func);                                                                       // 65\n        }                                                                                                         // 66\n      });                                                                                                         // 67\n    }                                                                                                             // 68\n  });                                                                                                             // 69\n                                                                                                                  // 70\n  FastRender.route(getPath(route), onRoute);                                                                      // 71\n                                                                                                                  // 72\n  function onRoute(params, path) {                                                                                // 73\n    var self = this;                                                                                              // 74\n    var context = {                                                                                               // 75\n      params: params,                                                                                             // 76\n      path: path                                                                                                  // 77\n    };                                                                                                            // 78\n                                                                                                                  // 79\n    //reset subscriptions;                                                                                        // 80\n    currentSubscriptions = [];                                                                                    // 81\n    subscriptionFunctions.forEach(function(func) {                                                                // 82\n      func.call(context);                                                                                         // 83\n    });                                                                                                           // 84\n                                                                                                                  // 85\n    // if there is a controller, try to initiate it and invoke potential                                          // 86\n    // methods which could give us subscriptions                                                                  // 87\n    var controller = getController(route);                                                                        // 88\n    if(controller && controller.prototype) {                                                                      // 89\n      if(typeof controller.prototype.lookupOption == 'function') {                                                // 90\n        // for IR 1.0                                                                                             // 91\n        // it is possible to create a controller invoke methods on it                                             // 92\n        var controllerInstance = new controller();                                                                // 93\n        controllerInstance.params = params;                                                                       // 94\n        controllerInstance.path = path;                                                                           // 95\n                                                                                                                  // 96\n        ['waitOn', 'subscriptions'].forEach(function(funcName) {                                                  // 97\n          if(controllerInstance[funcName]) {                                                                      // 98\n            controllerInstance[funcName].call(controllerInstance);                                                // 99\n          }                                                                                                       // 100\n        });                                                                                                       // 101\n      } else {                                                                                                    // 102\n        // IR 0.9                                                                                                 // 103\n        // hard to create a controller instance                                                                   // 104\n        // so this is the option we can take                                                                      // 105\n        var waitOn = controller.prototype.waitOn;                                                                 // 106\n        if(waitOn) {                                                                                              // 107\n          waitOn.call(context);                                                                                   // 108\n        }                                                                                                         // 109\n      }                                                                                                           // 110\n    }                                                                                                             // 111\n                                                                                                                  // 112\n    currentSubscriptions.forEach(function(args) {                                                                 // 113\n      self.subscribe.apply(self, args);                                                                           // 114\n    });                                                                                                           // 115\n  }                                                                                                               // 116\n}                                                                                                                 // 117\n                                                                                                                  // 118\nfunction getPath(route) {                                                                                         // 119\n  if(route._path) {                                                                                               // 120\n    // for IR 1.0                                                                                                 // 121\n    return route._path;                                                                                           // 122\n  } else {                                                                                                        // 123\n    // for IR 0.9                                                                                                 // 124\n    var name = (route.name == \"/\")? \"\" : name;                                                                    // 125\n    return route.options.path || (\"/\" + name);                                                                    // 126\n  }                                                                                                               // 127\n}                                                                                                                 // 128\n                                                                                                                  // 129\nfunction getController(route) {                                                                                   // 130\n  if(route.findControllerConstructor) {                                                                           // 131\n    // for IR 1.0                                                                                                 // 132\n    return route.findControllerConstructor();                                                                     // 133\n  } else if(route.findController) {                                                                               // 134\n    // for IR 0.9                                                                                                 // 135\n    return route.findController();                                                                                // 136\n  } else {                                                                                                        // 137\n    // unsupported version of IR                                                                                  // 138\n    return null;                                                                                                  // 139\n  }                                                                                                               // 140\n}                                                                                                                 // 141\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n"]}